<!doctype html>
<meta charset="utf-8" />
<title>File System Access API Demo</title>
<button id="open">파일 열기</button>
<button id="save" disabled>저장</button>
<button id="saveAs" disabled>다른 이름으로 저장</button>
<pre><textarea id="editor" style="width:100%;height:240px" disabled></textarea></pre>
<p id="status">파일을 열어 주세요.</p>
<script>
  let handle = null;
  const status = (t) => document.getElementById('status').textContent = t;

  async function ensurePermission(h, mode='readwrite') {
    const q = await h.queryPermission({ mode });
    if (q === 'granted') return;
    const r = await h.requestPermission({ mode });
    if (r !== 'granted') throw new Error('권한 거부됨');
  }

  document.getElementById('open').addEventListener('click', async () => {
    try {
      const [h] = await window.showOpenFilePicker({
        multiple: false,
        types: [{ description: '텍스트', accept: { 'text/plain': ['.txt', '.md', '.log'] } }]
      });
      await ensurePermission(h, 'readwrite');
      const file = await h.getFile();
      const text = await file.text();
      document.getElementById('editor').value = text;
      document.getElementById('editor').disabled = false;
      document.getElementById('save').disabled = false;
      document.getElementById('saveAs').disabled = false;
      handle = h;
      status('열림: ' + h.name);
    } catch (e) {
      status(e.message || '취소됨');
    }
  });

  async function saveTo(h) {
    await ensurePermission(h, 'readwrite');
    const writable = await h.createWritable();
    await writable.write(document.getElementById('editor').value);
    await writable.close();
    status('저장됨: ' + h.name);
  }

  document.getElementById('save').addEventListener('click', async () => {
    if (!handle) return status('열린 파일 없음');
    try { await saveTo(handle); } catch (e) { status(e.message || '저장 실패'); }
  });

  document.getElementById('saveAs').addEventListener('click', async () => {
    try {
      const h = await window.showSaveFilePicker({
        suggestedName: handle?.name || 'untitled.txt',
        types: [{ description: '텍스트', accept: { 'text/plain': ['.txt'] } }]
      });
      await saveTo(h);
      handle = h;
    } catch (e) { status(e.message || '다른 이름으로 저장 취소'); }
  });
</script>
